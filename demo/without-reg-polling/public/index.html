<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.qrcode@1.0.3/jquery.qrcode.min.js"></script>
    <title>Hypersign Login Demo</title>
  </head>

  <body>
    <div align="center">
      <h1>Login With QR Code</h1>
      <div id="qrcode">
        <img src="loader.gif" />
      </div>
      <p>OR</p>
      <p class="web"></p>
      <div id="profile"></div>
    </div>
  </body>

  <script type="text/javascript">
    $(document).ready(function () {
      initiatePoll();
    });

    async function initiatePoll() {
      try {
        clearHTML();
        const url = `http://${window.location.host}/challenge`;
        const rs = await fetch(url, {
          method: 'POST',
        })
        const js = await rs.json()
        const { hypersign } = js;
        const { data } = hypersign;
        const { challenge } = data;
        
        formQRCodeHTML(JSON.stringify(data));

        if (challenge) {
          const POLLING_INTERVAL = 5000; // ms
          /// start the polling
          const x = await poll(POLLING_INTERVAL, challenge);

          const { accessToken } = x;
          const url = `http://${window.location.host}/protected`;
          const resp = await fetch(url, {
            headers: {
              Authorization: 'Bearer ' + accessToken,
            },
            method: 'POST',
          });

          const json = await resp.json();
          if (json.status == 403) {
            console.log('error 403');
          } else {
            clearHTML();
            $('#profile').text(JSON.stringify(json.message));
          }
        }

      } catch (e) {
        console.log(e);
      }
    }

    function poll(interval, challenge) {
      return new Promise(function (resolve, reject) {
        const ticker = setInterval(function () {
          const url = `http://${window.location.host}/poll?challenge=${challenge}`;
          return fetch(url)
            .then((res) => res.json())
            .then((json) => {
              const { hypersign } = json;
              const { success, data } = hypersign;
              if (success && success === true) {
                clearInterval(ticker);
                resolve(data);
              }
            })
            .catch((e) => {
              console.log(e);
            });
        }, interval);
      });
    }

    function clearHTML(){
      $('#qrcode').html('');
      $('#web').html('');
      $('#profile').html('');
    }

    function formQRCodeHTML(qrDataStr) {
      // Display the QR code to use with mobile app
      $('#qrcode').qrcode({
        width: 300,
        height: 300,
        text: qrDataStr,
      });

      // OR use web wallet
      const weblink = encodeURI('https://hswallet-stage.netlify.app/deeplink?url=' + qrDataStr);
      $('.web').html(
        ` <button onclick="window.open('${weblink}', 'popUpWindow','height=800,width=400,left=100,top=100,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no, status=yes');">USE WEB WALLET</button>`
      );
    }
  </script>
</html>
